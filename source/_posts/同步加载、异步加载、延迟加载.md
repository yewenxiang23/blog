---
title: 同步加载、异步加载、延迟加载
date: 2018-09-29 11:29:12
categories: js
tags:
  - js加载方式
---

### 同步加载

平常默认用的都是`同步加载`。如：`<script src="http://XXX.com/script.js"></script>`
`同步模式`又称`阻塞模式`，会阻止浏览器的后续处理，停止了后续的文件的解析，执行，如图像的渲染。

一般的script标签（不带async等属性）加载时会阻塞浏览器，也就是说，浏览器在下载或执行该js代码块时，后面的标签不会被解析，例如在head中添加一个script，但这个script下载时网络不稳定，很长时间没有下载完成对应的js文件，那么浏览器此时一直等待这个js文件下载，此时页面不会被渲染，用户看到的就是白屏。

流览器之所以会采用同步模式，是因为加载的js文件中有对dom的操作，重定向，输出document等默认行为，所以同步才是最安全的。通常会把要加载的js放到body结束标签之前，使得js可在页面最后加载，尽量减少阻塞页面的渲染。这样可以先让页面显示出来。

### 异步加载 (async loading)

常见异步加载举例：
```js
(function() {
var s = document.createElement('script');
s.type = 'text/javascript';
s.async = true;
s.src = 'http://XXX.com/script.js';
var x = document.getElementsByTagName('script')[0];
 x.parentNode.insertBefore(s, x);
})();
```

`异步加载`也叫`非阻塞模式加载`，浏览器在下载js的同时，同时还会执行后续的页面处理。
在script标签内，用js创建一个script元素并插入到document中，这种就是异步加载js文件了。

同步加载流程是瀑布模型，异步加载流程是并发模型。

### 延迟加载 (lazy loading)

有些 js 代码并不是页面初始化的时候就立刻需要的，而稍后的某些情况才需要的。延迟加载就是一开始并不加载这些暂时不用的js，而是在需要的时候或稍后再通过js 的控制来异步加载。
也就是将 js 切分成许多模块，页面初始化时只加载需要立即执行的 js ，然后其它 js 的加载延迟到第一次需要用到的时候再加载。
特别是页面有大量不同的模块组成，很多可能暂时不用或根本就没用到。
就像图片的延迟加载，在图片出现在可视区域内时（在滚动条下拉）才加载显示图片。

### 预加载

预加载是一种浏览器机制，使用浏览器空闲时间来预先下载/加载用户接下来很可能会浏览的页面/资源，当用户访问某个预加载的链接时，如果从缓存命中,页面就得以快速呈现。

### HTML页面加载和解析流程

- 用户输入网址访问静态的资源文件（假设是个html页面，并且是第一次访问，此时确保文件不是从缓存里取出），浏览器向服务器发出请求，服务器返回html文件。
- 浏览器开始载入html代码，发现<head>标签内有一个<link>标签引用外部CSS文件。
- 浏览器又发出CSS文件的请求，服务器返回这个CSS文件。
- 浏览器继续载入html中<body>部分的代码，并且CSS文件已经拿到手了，可以开始渲染页面了。
- 浏览器在代码中发现一个<img>标签引用了一张图片，向服务器发出请求。此时浏览器不会等到图片下载完，而是继续渲染后面的代码。
- 服务器返回图片文件，由于图片占用了一定面积，影响了后面段落的排布，因此浏览器需要回过头来重新渲染这部分代码。
- 浏览器发现了一个包含一行JavaScript代码的<script>标签，赶快运行它。
- Javascript脚本执行了这条语句，它命令浏览器隐藏掉代码中的某个<style>（style.display=”none”）。
- 当遇到</html>代码时，渲染结束。

### 加载方式

```js
window.onload = function(){
  // some code
}
```

这段代码会在 **整个页面的document全部加载完成以后执行**。不幸的这种方式不仅要求页面的DOM tree全部加载完成，而且要求所有的外部图片和资源全部加载完成。更不幸的是，如果外部资源，例如图片需要很长时间来加载，那么这个js效果就会让用户感觉失效了。

```js
$(document).ready(function(){
  //some code
})
```
简写形式：

```js
$(function(){
  //some code
})
```
就仅仅 **只需要加载所有的DOM结构**，在浏览器把所有的HTML放入DOM树之前就执行js效果。包括在加载外部图片和资源之前。